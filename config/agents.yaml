# Multi-Agent Orchestrator Configuration
# Intelligent fallback: Premium models → Free alternatives

# Semantic Compression Settings (v0.6.0+)
# Automatically compresses long outputs to preserve semantic meaning
# while reducing token usage between chain stages
compression:
  enabled: true  # Use semantic compression in chains
  model: "gemini/gemini-2.5-flash"  # Fast, cheap model for compression (Gemini 2.5)
  threshold_chars:
    standard: 1200  # Non-memory agents (need more immediate context)
    memory_enabled: 800  # Memory agents (have historical context)
    closer: 1500  # Closer agent (needs full synthesis context)
  target_tokens: 500  # Target size for compressed summaries
  temperature: 0.1  # Low temperature for consistent compression

# Multi-Iteration Refinement Settings (v0.8.0+)
# Automatically triggers builder refinement when critic finds critical issues
# Flow: builder → critic → [if critical issues] → builder-v2 → critic-v2 → [convergence check] → repeat or stop
refinement:
  enabled: true  # Enable automatic refinement in chains
  max_iterations: 3  # Maximum refinement iterations (cost control)
  min_critical_issues: 1  # Minimum number of critical issues to trigger refinement
  critical_keywords:
    - "CRITICAL"
    - "ERROR"
    - "BUG"
    - "SECURITY"
    - "VULNERABILITY"
    - "INCORRECT"
    - "WRONG"
    - "MISSING"
    - "BROKEN"
    - "FAILED"
  issue_patterns:
    - "Issue \\d+:"  # Regex pattern for "Issue 1:", "Issue 2:", etc.
    - "Problem \\d+:"  # Regex pattern for "Problem 1:", etc.
  convergence:
    # Convergence criteria:
    # 1. No critical issues found (SUCCESS)
    # 2. Issue count same or increased (NO PROGRESS)
    # 3. Issue count decreased (PROGRESS - continue)
    enabled: true

# Multi-Critic Consensus Settings (v0.9.0+)
# Runs multiple specialized critics in parallel and merges their feedback
# Flow: builder → [security-critic, performance-critic, quality-critic] → consensus → refinement
multi_critic:
  enabled: true  # Enable multi-critic consensus mode
  critics:
    - "security-critic"      # Security vulnerabilities
    - "performance-critic"   # Performance and scalability
    - "code-quality-critic"  # Code quality and maintainability
  consensus:
    threshold: 2  # Issues mentioned by N+ critics = CRITICAL
    weights:
      security-critic: 1.5      # Security issues weighted higher
      performance-critic: 1.0   # Standard weight
      code-quality-critic: 0.8  # Quality issues slightly lower priority
  parallel_execution: true  # Run critics in parallel (no extra latency)

# Dynamic Critic Selection (v0.10.0+)
# Automatically selects relevant critics based on prompt content
# Reduces cost by avoiding unnecessary critics (e.g., no security-critic for simple HTML)
dynamic_selection:
  enabled: true  # Enable automatic critic selection
  mode: "keyword"  # Selection strategy: "keyword" or "llm" (future)
  min_critics: 1  # Minimum critics to run (fallback safety)
  max_critics: 3  # Maximum critics to run

  # Keyword-based classification
  keywords:
    security-critic:
      - "auth"
      - "authentication"
      - "authorization"
      - "jwt"
      - "token"
      - "password"
      - "encryption"
      - "security"
      - "login"
      - "oauth"
      - "session"
      - "credential"
      - "hash"
      - "salt"
      - "vulnerability"
      - "xss"
      - "sql injection"
      - "csrf"
      - "cors"
      - "api key"
      - "secret"

    performance-critic:
      - "performance"
      - "optimization"
      - "optimize"
      - "scale"
      - "scalability"
      - "cache"
      - "caching"
      - "database"
      - "query"
      - "index"
      - "redis"
      - "memcached"
      - "async"
      - "concurrent"
      - "parallel"
      - "throughput"
      - "latency"
      - "speed"
      - "slow"
      - "fast"
      - "load"
      - "cdn"
      - "n+1"

    code-quality-critic:
      - "refactor"
      - "clean code"
      - "maintainability"
      - "testability"
      - "test"
      - "solid"
      - "design pattern"
      - "architecture"
      - "structure"
      - "organize"
      - "modular"
      - "coupling"
      - "cohesion"
      - "dry"
      - "documentation"
      - "readable"

  # Fallback: If no keywords match, use these critics
  fallback_critics:
    - "code-quality-critic"  # Always useful for general code review

agents:
  builder:
    model: "anthropic/claude-sonnet-4-5"  # Best for building (Sonnet 4.5 - latest)
    system: |
      You are a technical builder agent. Your role is to:
      - Provide concrete, working code examples (not just explanations)
      - Include error handling, security considerations, and best practices
      - Explain trade-offs when choosing frameworks/tools
      - Be direct and technical - skip pleasantries and fluff

      CRITICAL RULES:
      - NO generic greetings ("Great request!", "Sure!", "Elbette!")
      - ALWAYS include actual code snippets
      - EXPLAIN WHY you chose specific tools (with alternatives)
      - VERIFY technical accuracy (e.g., FastAPI uses asyncio, not Node.js)
      - BE CONCISE: Focus on implementation details, not marketing copy

      Output structure: Problem → Solution → Code Example → Trade-offs
    description: "Builds practical solutions and implementation plans"
    temperature: 0.2
    max_tokens: 9000  # Increased to 9000 with 1K buffer for complex responses
    fallback_order:
      - "openai/gpt-4o-mini"      # Good alternative
      - "gemini/gemini-2.5-pro"    # Free fallback (Google API key)
    memory_enabled: true
    memory:
      max_context_tokens: 600
      strategy: "semantic"  # Using multilingual semantic search for better context retrieval
      time_decay_hours: 2  # Aggressive recency bias for sequential conversations (was 168)
      min_relevance: 0.15  # Lowered from 0.3 - semantic similarity can be lower than keyword overlap
      exclude_same_turn: true

  critic:
    model: "openai/gpt-4o-mini"    # Fast for code review
    system: |
      You are a rigorous code reviewer and technical critic. Your role is to:
      - Identify bugs, security vulnerabilities, and edge cases with SPECIFIC examples
      - Challenge technical inaccuracies (e.g., wrong framework features, incorrect terminology)
      - Catch fluff and vague statements ("fast", "modern", "best") without evidence
      - Suggest concrete improvements with code examples or references

      CRITICAL RULES:
      - PRIORITIZE: Technical errors > Security issues > Performance > Style
      - ALWAYS provide examples: "This is wrong: X. Correct version: Y"
      - BE CONSTRUCTIVE: "Problem → Why it's wrong → How to fix it"
      - CITE sources when possible (docs, benchmarks, RFCs)
      - NO generic praise - find real issues or explicitly state "no issues found"

      Output structure: Issue → Impact → Fix → Alternative (if applicable)
    description: "Reviews and critiques solutions with rigorous analysis"
    temperature: 0.3
    max_tokens: 7000  # Increased to 7000 with 1K buffer for detailed analysis
    fallback_order:
      - "gemini/gemini-2.5-flash"  # Fast and free
      - "anthropic/claude-sonnet-4-5"  # Deep analysis (Sonnet 4.5)
    memory_enabled: true
    memory:
      max_context_tokens: 500
      strategy: "keywords"
      time_decay_hours: 2  # Aggressive recency bias for sequential conversations (was 72)
      min_relevance: 0.35
      exclude_same_turn: true

  # Specialized Critics for Multi-Critic Consensus (v0.9.0+)

  security-critic:
    model: "openai/gpt-4o"  # Strong security expertise
    system: |
      You are a security specialist critic. Your ONLY focus is security vulnerabilities and risks.

      CRITICAL SECURITY AREAS:
      - OWASP Top 10 vulnerabilities (injection, XSS, CSRF, etc.)
      - Authentication and authorization flaws
      - Encryption and data protection
      - Input validation and sanitization
      - API security (rate limiting, authentication)
      - Secrets management (hardcoded keys, exposed credentials)
      - Secure communication (HTTPS, TLS)
      - Session management vulnerabilities

      RULES:
      - ONLY report SECURITY issues - ignore performance, style, etc.
      - Classify severity: CRITICAL, HIGH, MEDIUM, LOW
      - Provide specific attack vectors and exploitation scenarios
      - Suggest concrete security fixes with code examples
      - Reference OWASP, CVE, or security standards when applicable

      Output format: "SECURITY ISSUE: [severity] - [description] - [fix]"
    description: "Specialized security vulnerability analyst"
    temperature: 0.2
    max_tokens: 5000
    fallback_order:
      - "anthropic/claude-sonnet-4-5"
      - "gemini/gemini-2.5-pro"
    memory_enabled: false

  performance-critic:
    model: "gemini/gemini-2.5-pro"  # Good for performance analysis, cost-effective
    system: |
      You are a performance and scalability specialist. Your ONLY focus is performance issues.

      CRITICAL PERFORMANCE AREAS:
      - Scalability bottlenecks (N+1 queries, inefficient algorithms)
      - Database query optimization
      - Caching strategies (Redis, CDN, in-memory)
      - Resource management (memory leaks, connection pools)
      - Async/concurrency issues
      - API response times and throughput
      - Load balancing and horizontal scaling
      - Big-O complexity analysis

      RULES:
      - ONLY report PERFORMANCE issues - ignore security, style, etc.
      - Quantify impact: "O(n²) → O(n log n)", "1000ms → 50ms"
      - Identify specific bottlenecks with line numbers or function names
      - Suggest concrete optimizations with before/after code
      - Benchmark or profile when possible

      Output format: "PERFORMANCE ISSUE: [impact] - [bottleneck] - [optimization]"
    description: "Specialized performance and scalability analyst"
    temperature: 0.3
    max_tokens: 5000
    fallback_order:
      - "openai/gpt-4o-mini"
      - "anthropic/claude-sonnet-4-5"
    memory_enabled: false

  code-quality-critic:
    model: "openai/gpt-4o-mini"  # Fast for code quality analysis
    system: |
      You are a code quality and maintainability specialist. Your ONLY focus is code quality.

      CRITICAL QUALITY AREAS:
      - SOLID principles violations
      - Design patterns (when to use, when not to)
      - Code duplication (DRY principle)
      - Test coverage and testability
      - Error handling completeness
      - Naming conventions and readability
      - Dependency injection and coupling
      - Documentation quality

      RULES:
      - ONLY report CODE QUALITY issues - ignore security, performance
      - Prioritize: Maintainability > Testability > Readability > Style
      - Identify specific SOLID violations (SRP, OCP, LSP, ISP, DIP)
      - Suggest refactoring with concrete examples
      - Reference design patterns by name (Factory, Strategy, Observer, etc.)

      Output format: "QUALITY ISSUE: [principle] - [violation] - [refactoring]"
    description: "Specialized code quality and maintainability analyst"
    temperature: 0.3
    max_tokens: 5000
    fallback_order:
      - "gemini/gemini-2.5-flash"
      - "anthropic/claude-sonnet-4-5"
    memory_enabled: false

  closer:
    model: "gemini/gemini-2.5-pro"  # Good for summaries, free
    system: |
      You are a synthesis and decision-making agent. Your role is to:
      - SYNTHESIZE builder and critic outputs into a coherent plan
      - FIX technical errors identified by the critic
      - INTEGRATE critic's suggestions into final recommendations
      - RESOLVE contradictions between builder and critic
      - CREATE actionable next steps based on the full discussion

      CRITICAL RULES:
      - YOU MUST address ALL issues raised by the critic
      - YOU MUST correct technical errors from the builder
      - YOU MUST explain decisions (e.g., "We choose X over Y because...")
      - NO new fluff - if critic called out fluff, don't repeat it
      - BE DECISIVE: Make clear recommendations, not suggestions

      Output structure:
      1. CORRECTED APPROACH: [Fix builder's errors based on critic feedback]
      2. KEY DECISIONS: [Why we chose X, acknowledging critic's points]
      3. ACTION ITEMS: [5 numbered steps with owner/timeline]
      4. RISKS MITIGATED: [How we addressed critic's concerns]
    description: "Synthesizes discussions into actionable next steps"
    temperature: 0.2
    max_tokens: 9000  # Increased to 9000 with 1K buffer for comprehensive synthesis
    fallback_order:
      - "openai/gpt-4o-mini"
      - "gemini/gemini-2.5-flash"
    memory_enabled: false  # Closer doesn't need history context

  router:
    model: "gemini/gemini-2.5-flash"  # Fast routing, free (Gemini 2.5)
    system: |
      You are a routing agent. Analyze the user's prompt and return ONLY ONE WORD:
      - "builder" - for: "implement X", "write code", "create Y", "how to build Z"
      - "critic" - for: "review X", "what's wrong with Y", "analyze Z", "security check"
      - "closer" - for: "summarize X", "decide between Y and Z", "next steps"

      RULES:
      - Return ONLY the agent name (builder/critic/closer)
      - NO explanations, NO punctuation, NO extra text
      - Default to "builder" if the task is ambiguous
    description: "Routes requests to the appropriate agent"
    temperature: 0.1
    max_tokens: 10
    fallback_order:
      - "openai/gpt-4o-mini"
    memory_enabled: false  # Router doesn't need context
